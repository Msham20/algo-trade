<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY 5-Min Signal Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nifty-dashboard.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body class="nifty-page">
    <div class="container">
        <!-- Header -->
        <header class="header nifty-header">
            <div class="header-content">
                <div class="header-left">
                    <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i></a>
                    <h1><i class="fas fa-chart-line"></i> NIFTY 5-Min Signal Analyzer</h1>
                </div>
                <div class="header-right">
                    <button id="connectZerodhaBtn" class="connect-btn">
                        <i class="fas fa-plug"></i> Connect Zerodha
                    </button>
                    <span id="connectionBadge" class="connection-badge disconnected">
                        <i class="fas fa-circle"></i> OFF
                    </span>
                    <span class="timeframe-badge">5 MIN</span>
                    <span class="live-indicator">
                        <span class="pulse"></span> LIVE
                    </span>
                </div>
            </div>
        </header>

        <main class="main-content nifty-main">
            <!-- Top Stats Row -->
            <div class="stats-row">
                <div class="stat-card price-card">
                    <div class="stat-label">NIFTY 50</div>
                    <div class="stat-value" id="niftyPrice">--</div>
                    <div class="stat-change" id="priceChange">--</div>
                </div>

                <div class="stat-card signal-card" id="signalCard">
                    <div class="stat-label">SIGNAL</div>
                    <div class="stat-value signal-badge" id="signalValue">--</div>
                    <div class="stat-change" id="signalStrength">Strength: --</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">STOP LOSS</div>
                    <div class="stat-value" id="stopLoss">--</div>
                    <div class="stat-change loss">Risk Level</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">TARGET</div>
                    <div class="stat-value" id="target">--</div>
                    <div class="stat-change profit" id="riskReward">R:R --</div>
                </div>
            </div>

            <!-- Chart Section -->
            <section class="chart-section">
                <div class="chart-header">
                    <h2><i class="fas fa-chart-candlestick"></i> Price Chart</h2>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-days="1">1D</button>
                        <button class="chart-btn" data-days="2">2D</button>
                        <button class="chart-btn" data-days="5">5D</button>
                        <button class="refresh-btn" id="refreshChart">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="chartContainer" class="chart-container"></div>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-color ema9"></span> EMA 9</span>
                    <span class="legend-item"><span class="legend-color ema21"></span> EMA 21</span>
                    <span class="legend-item"><span class="legend-color supertrend"></span> SuperTrend</span>
                    <span class="legend-item"><span class="legend-color vwap"></span> VWAP</span>
                </div>
            </section>

            <!-- Auto Trading Control Panel -->
            <section class="auto-trading-section">
                <div class="auto-header">
                    <h2><i class="fas fa-robot"></i> Auto Trading (Paper Mode)</h2>
                    <div class="auto-status">
                        <span class="auto-indicator" id="autoIndicator">
                            <span class="status-dot off"></span>
                            <span id="autoStatusText">OFF</span>
                        </span>
                    </div>
                </div>

                <!-- Auto trading settings -->
                <div class="auto-settings-bar">
                    <div class="setting-item">
                        <label>Min Strength:</label>
                        <input type="number" id="minStrengthInput" value="40" min="0" max="100">
                    </div>
                    <div class="setting-item">
                        <label>Quantity:</label>
                        <input type="number" id="quantityInput" value="50" min="1">
                    </div>
                    <div class="setting-item">
                        <label>Max Trades:</label>
                        <input type="number" id="maxTradesInput" value="5" min="1">
                    </div>
                </div>

                <div class="auto-controls">
                    <button class="auto-btn start-btn" id="startAutoBtn">
                        <i class="fas fa-play"></i> Start Auto Trade
                    </button>
                    <button class="auto-btn stop-btn" id="stopAutoBtn">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="auto-btn trade-now-btn" id="tradeNowBtn">
                        <i class="fas fa-bolt"></i> Trade Now
                    </button>
                </div>

                <!-- Live Auto Logs -->
                <div class="live-logs-container">
                    <div class="logs-header">
                        <span><i class="fas fa-terminal"></i> Live Activity</span>
                        <button id="clearLogsBtn"><i class="fas fa-trash"></i></button>
                    </div>
                    <div id="autoLogsList" class="auto-logs-list">
                        <div class="log-placeholder">No activity logged yet...</div>
                    </div>
                </div>
                <div class="auto-stats">
                    <div class="auto-stat">
                        <span class="stat-label">Trades Today</span>
                        <span class="stat-value" id="tradesToday">0</span>
                    </div>
                    <div class="auto-stat">
                        <span class="stat-label">Total Profit</span>
                        <span class="stat-value profit" id="totalProfit">₹0</span>
                    </div>
                    <div class="auto-stat">
                        <span class="stat-label">Total Loss</span>
                        <span class="stat-value loss" id="totalLoss">₹0</span>
                    </div>
                    <div class="auto-stat">
                        <span class="stat-label">Current P&L</span>
                        <span class="stat-value" id="totalPnl">₹0</span>
                    </div>
                </div>
            </section>

            <!-- Two Column Layout -->
            <div class="two-column">
                <!-- Active Signals -->
                <section class="signals-section">
                    <h2><i class="fas fa-bell"></i> Active Signals</h2>
                    <div id="signalsList" class="signals-list">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Loading signals...
                        </div>
                    </div>
                </section>

                <!-- Indicators Panel -->
                <section class="indicators-section">
                    <h2><i class="fas fa-tachometer-alt"></i> Indicators</h2>
                    <div id="indicatorsList" class="indicators-grid">
                        <div class="indicator-item">
                            <span class="indicator-name">RSI</span>
                            <span class="indicator-value" id="rsiValue">--</span>
                            <div class="indicator-bar">
                                <div class="indicator-fill rsi-fill" id="rsiFill"></div>
                            </div>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">MACD</span>
                            <span class="indicator-value" id="macdValue">--</span>
                            <span class="indicator-status" id="macdStatus">--</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">SuperTrend</span>
                            <span class="indicator-value" id="supertrendValue">--</span>
                            <span class="indicator-status" id="supertrendStatus">--</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">VWAP</span>
                            <span class="indicator-value" id="vwapValue">--</span>
                            <span class="indicator-status" id="vwapStatus">--</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">EMA 9/21</span>
                            <span class="indicator-value" id="emaValue">--</span>
                            <span class="indicator-status" id="emaStatus">--</span>
                        </div>
                        <div class="indicator-item">
                            <span class="indicator-name">ATR</span>
                            <span class="indicator-value" id="atrValue">--</span>
                            <span class="indicator-status neutral">Volatility</span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Support/Resistance & Patterns -->
            <div class="two-column">
                <section class="sr-section">
                    <h2><i class="fas fa-layer-group"></i> Support & Resistance</h2>
                    <div class="sr-grid">
                        <div class="sr-column resistance">
                            <h3>Resistance</h3>
                            <ul id="resistanceLevels">
                                <li>--</li>
                            </ul>
                        </div>
                        <div class="sr-column support">
                            <h3>Support</h3>
                            <ul id="supportLevels">
                                <li>--</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="patterns-section">
                    <h2><i class="fas fa-shapes"></i> Candlestick Patterns</h2>
                    <div id="patternsList" class="patterns-list">
                        <div class="no-patterns">No patterns detected</div>
                    </div>
                </section>
            </div>

            <!-- CPR & Fibonacci Section -->
            <div class="two-column">
                <section class="cpr-section">
                    <h2><i class="fas fa-bullseye"></i> Central Pivot Range (CPR)</h2>
                    <div class="cpr-grid" id="cprGrid">
                        <div class="cpr-item">
                            <span class="cpr-label">TC (Top)</span>
                            <span class="cpr-value" id="cprTC">--</span>
                        </div>
                        <div class="cpr-item highlight">
                            <span class="cpr-label">PIVOT</span>
                            <span class="cpr-value" id="cprPivot">--</span>
                        </div>
                        <div class="cpr-item">
                            <span class="cpr-label">BC (Bottom)</span>
                            <span class="cpr-value" id="cprBC">--</span>
                        </div>
                    </div>
                    <div class="cpr-info">
                        <span id="cprType" class="cpr-badge">Type: --</span>
                        <span id="cprWidth" class="cpr-width">Width: --%</span>
                    </div>
                    <div class="pivot-levels">
                        <div class="pivot-col">
                            <h4>Resistance</h4>
                            <div class="pivot-val">R1: <span id="pivotR1">--</span></div>
                            <div class="pivot-val">R2: <span id="pivotR2">--</span></div>
                            <div class="pivot-val">R3: <span id="pivotR3">--</span></div>
                        </div>
                        <div class="pivot-col">
                            <h4>Support</h4>
                            <div class="pivot-val">S1: <span id="pivotS1">--</span></div>
                            <div class="pivot-val">S2: <span id="pivotS2">--</span></div>
                            <div class="pivot-val">S3: <span id="pivotS3">--</span></div>
                        </div>
                    </div>
                </section>

                <section class="fibonacci-section">
                    <h2><i class="fas fa-percentage"></i> Fibonacci Retracement</h2>
                    <div class="fib-list" id="fibList">
                        <div class="fib-item">
                            <span class="fib-level">0% (High)</span>
                            <span class="fib-price" id="fibHigh">--</span>
                        </div>
                        <div class="fib-item">
                            <span class="fib-level">23.6%</span>
                            <span class="fib-price" id="fib236">--</span>
                        </div>
                        <div class="fib-item">
                            <span class="fib-level">38.2%</span>
                            <span class="fib-price" id="fib382">--</span>
                        </div>
                        <div class="fib-item highlight">
                            <span class="fib-level">50.0%</span>
                            <span class="fib-price" id="fib500">--</span>
                        </div>
                        <div class="fib-item golden">
                            <span class="fib-level">61.8% (Golden)</span>
                            <span class="fib-price" id="fib618">--</span>
                        </div>
                        <div class="fib-item">
                            <span class="fib-level">78.6%</span>
                            <span class="fib-price" id="fib786">--</span>
                        </div>
                        <div class="fib-item">
                            <span class="fib-level">100% (Low)</span>
                            <span class="fib-price" id="fibLow">--</span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Last Updated -->
            <div class="last-updated">
                <i class="fas fa-clock"></i> Last updated: <span id="lastUpdated">--</span>
                <span class="auto-refresh">Auto-refresh in <span id="countdown">30</span>s</span>
            </div>
        </main>
    </div>

    <!-- Zerodha Credentials Modal -->
    <div id="zerodhaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Zerodha API Setup</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="zerodhaForm">
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <input type="text" id="apiKey" name="apiKey" placeholder="Enter API Key" required>
                    </div>
                    <div class="form-group">
                        <label for="apiSecret">API Secret</label>
                        <input type="password" id="apiSecret" name="apiSecret" placeholder="Enter API Secret" required>
                    </div>
                    <div class="form-group">
                        <label for="userId">User ID</label>
                        <input type="text" id="userId" name="userId" placeholder="Enter User ID" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter Password" required>
                    </div>
                    <div class="form-group">
                        <label for="totpSecret">TOTP Secret (Optional)</label>
                        <input type="text" id="totpSecret" name="totpSecret" placeholder="Enter TOTP Secret">
                        <small>Leave blank if not using automated login</small>
                    </div>
                    <button type="submit" class="btn-submit">Save & Connect</button>
                    <div class="modal-info">
                        <i class="fas fa-info-circle"></i> Credentials will be saved to your local .env file.
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/nifty-charts.js') }}"></script>
</body>

</html>